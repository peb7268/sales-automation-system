#!/bin/bash

# Sales Pipeline Global Command Installer
# Installs global bin commands for sales-pipeline component

set -e

COMPONENT_NAME="sales-pipeline"
COMPONENT_PATH="$(cd "$(dirname "$0")/.." && pwd)"
INSTALL_DIR="/usr/local/bin"

echo "ðŸš€ Installing global commands for $COMPONENT_NAME..."
echo "Component path: $COMPONENT_PATH"

# Check if we have write permissions to /usr/local/bin
if [ ! -w "$INSTALL_DIR" ]; then
    echo "âŒ No write permission to $INSTALL_DIR"
    echo "Please run with sudo: sudo npm run install:global"
    exit 1
fi

# Create global command scripts
create_global_script() {
    local cmd_name="$1"
    local npm_script="$2"
    local description="$3"
    
    cat > "$INSTALL_DIR/$cmd_name" << EOF
#!/bin/bash
# $description
# Auto-generated by sales-pipeline component installer

SALES_PIPELINE_PATH="$COMPONENT_PATH"

if [ ! -d "\$SALES_PIPELINE_PATH" ]; then
    echo "âŒ Sales pipeline component not found at: \$SALES_PIPELINE_PATH"
    echo "Please reinstall the sales-pipeline component"
    exit 1
fi

cd "\$SALES_PIPELINE_PATH"
npm run $npm_script "\$@"
EOF
    
    chmod +x "$INSTALL_DIR/$cmd_name"
    echo "âœ… Installed: $cmd_name -> npm run $npm_script"
}

# Install core sales commands
create_global_script "sales-prospect" "add-prospect-enhanced" "Enhanced prospect research and qualification"
create_global_script "sales-pitch" "generate-pitches" "Generate AI-powered sales pitches"
create_global_script "sales-analytics" "update-analytics" "Update sales analytics dashboard"
create_global_script "sales-kanban" "sync-kanban" "Sync Obsidian Kanban boards"
create_global_script "sales-status" "prospect:status" "Check prospect processing status"
create_global_script "sales-dev" "dev" "Start sales pipeline in development mode"

# Install agent commands
create_global_script "mastra-prospect" "mastra:prospect" "Run Mastra prospecting agent"
create_global_script "mastra-pitch" "mastra:pitch" "Run Mastra pitch creator agent"
create_global_script "mastra-status" "mastra:status" "Check Mastra agent status"

echo ""
echo "ðŸŽ‰ Global sales commands installed successfully!"
echo ""
echo "Available commands:"
echo "  sales-prospect <business-name>  - Research and add prospect"
echo "  sales-pitch                     - Generate sales pitches"
echo "  sales-analytics                 - Update analytics dashboard"
echo "  sales-kanban                    - Sync Kanban boards"
echo "  sales-status                    - Check processing status"
echo "  sales-dev                       - Development mode"
echo "  mastra-prospect                 - Mastra prospecting agent"
echo "  mastra-pitch                    - Mastra pitch creator"
echo "  mastra-status                   - Mastra status check"
echo ""
echo "Example usage:"
echo "  sales-prospect \"Mile High Bistro\""
echo "  sales-pitch --all --evaluate"
echo "  sales-analytics"
echo ""