<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js - Sankey Diagram Example</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .chart-container {
            margin: 30px 0;
        }
        .link {
            fill: none;
            stroke-opacity: 0.5;
        }
        .link:hover {
            stroke-opacity: 0.8;
        }
        .node rect {
            cursor: move;
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }
        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
            font-size: 12px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>D3.js - Sankey Diagram Examples</h1>
        <div id="chart1" class="chart-container">
            <h2>Sales Pipeline Flow</h2>
        </div>
        <div id="chart2" class="chart-container">
            <h2>Energy Flow Diagram</h2>
        </div>
    </div>
    <div class="tooltip"></div>

    <script>
        // Sales Pipeline Sankey
        (function() {
            const width = 1160;
            const height = 500;
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };

            // Create SVG
            const svg = d3.select('#chart1')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create sankey generator
            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

            // Sales pipeline data
            const data = {
                nodes: [
                    { name: "Leads" },
                    { name: "Qualified Leads" },
                    { name: "Opportunities" },
                    { name: "Proposals" },
                    { name: "Closed Won" },
                    { name: "Closed Lost" },
                    { name: "Disqualified" }
                ],
                links: [
                    { source: 0, target: 1, value: 800 },
                    { source: 0, target: 6, value: 200 },
                    { source: 1, target: 2, value: 600 },
                    { source: 1, target: 6, value: 200 },
                    { source: 2, target: 3, value: 400 },
                    { source: 2, target: 5, value: 200 },
                    { source: 3, target: 4, value: 250 },
                    { source: 3, target: 5, value: 150 }
                ]
            };

            // Generate the sankey diagram
            const { nodes, links } = sankey(data);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(["Leads", "Qualified Leads", "Opportunities", "Proposals", "Closed Won", "Closed Lost", "Disqualified"])
                .range(["#4e79a7", "#f28e2c", "#e15759", "#76b7b2", "#59a14f", "#edc949", "#af7aa1"]);

            // Tooltip
            const tooltip = d3.select('.tooltip');

            // Add links
            svg.append('g')
                .selectAll('.link')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', d => color(d.source.name))
                .attr('stroke-width', d => Math.max(1, d.width))
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`${d.source.name} → ${d.target.name}<br/>Value: ${d.value}`);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });

            // Add nodes
            const node = svg.append('g')
                .selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', 'node');

            // Add rectangles for nodes
            node.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', d => color(d.name))
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`${d.name}<br/>Total: ${d.value}`);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });

            // Add labels
            node.append('text')
                .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .text(d => d.name);
        })();

        // Energy Flow Sankey
        (function() {
            const width = 1160;
            const height = 500;
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };

            // Create SVG
            const svg = d3.select('#chart2')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create sankey generator
            const sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(15)
                .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

            // Energy flow data
            const data = {
                nodes: [
                    { name: "Solar" },
                    { name: "Wind" },
                    { name: "Hydro" },
                    { name: "Natural Gas" },
                    { name: "Coal" },
                    { name: "Grid" },
                    { name: "Residential" },
                    { name: "Commercial" },
                    { name: "Industrial" },
                    { name: "Transportation" }
                ],
                links: [
                    { source: 0, target: 5, value: 150 },
                    { source: 1, target: 5, value: 200 },
                    { source: 2, target: 5, value: 180 },
                    { source: 3, target: 5, value: 300 },
                    { source: 4, target: 5, value: 250 },
                    { source: 5, target: 6, value: 280 },
                    { source: 5, target: 7, value: 320 },
                    { source: 5, target: 8, value: 380 },
                    { source: 5, target: 9, value: 100 }
                ]
            };

            // Generate the sankey diagram
            const { nodes, links } = sankey(data);

            // Color scale
            const color = d3.scaleOrdinal()
                .domain(data.nodes.map(d => d.name))
                .range(d3.schemeSet3);

            // Tooltip
            const tooltip = d3.select('.tooltip');

            // Add gradient definitions
            const defs = svg.append('defs');
            
            links.forEach((link, i) => {
                const gradient = defs.append('linearGradient')
                    .attr('id', `gradient-${i}`)
                    .attr('gradientUnits', 'userSpaceOnUse')
                    .attr('x1', link.source.x1)
                    .attr('x2', link.target.x0);
                
                gradient.append('stop')
                    .attr('offset', '0%')
                    .attr('stop-color', color(link.source.name));
                    
                gradient.append('stop')
                    .attr('offset', '100%')
                    .attr('stop-color', color(link.target.name));
            });

            // Add links with gradients
            svg.append('g')
                .selectAll('.link')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('d', d3.sankeyLinkHorizontal())
                .attr('stroke', (d, i) => `url(#gradient-${i})`)
                .attr('stroke-width', d => Math.max(1, d.width))
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`${d.source.name} → ${d.target.name}<br/>Energy: ${d.value} MW`);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });

            // Add nodes
            const node = svg.append('g')
                .selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', 'node');

            // Add rectangles for nodes
            node.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', d => color(d.name))
                .attr('stroke', '#000')
                .attr('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    tooltip.style('opacity', 1)
                        .html(`${d.name}<br/>Total: ${d.value} MW`);
                })
                .on('mousemove', function(event) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 10) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });

            // Add labels
            node.append('text')
                .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
                .text(d => d.name)
                .style('font-weight', 'bold');
        })();
    </script>
</body>
</html>